<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Installer - Model Interface</title>
    <style>
        :root {
            --bg-primary: #1e1e1e;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #3d3d3d;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --accent: #007acc;
            --accent-hover: #005a9e;
            --success: #4caf50;
            --error: #f44336;
            --warning: #ff9800;
            --border: #444444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background-color: var(--bg-secondary);
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .model-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .model-name {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .model-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--success);
        }

        /* Settings Button */
        .settings-btn {
            background: none;
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .settings-btn:hover {
            background-color: var(--bg-tertiary);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Chat Interface (for language models) */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            gap: 1rem;
            overflow: hidden;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background-color: var(--bg-secondary);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            border-radius: 8px;
            background-color: var(--bg-tertiary);
        }

        .message.user {
            background-color: var(--accent);
            background-opacity: 0.1;
        }

        .message-role {
            font-weight: 600;
            min-width: 80px;
        }

        .message-content {
            flex: 1;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .thinking-section {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 1rem;
            margin-bottom: 0.5rem;
        }

        .thinking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .thinking-content {
            font-size: 0.9rem;
            color: var(--text-secondary);
            max-height: 200px;
            overflow-y: auto;
        }

        /* Input Area */
        .input-container {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            background-color: var(--bg-secondary);
            border-radius: 8px;
        }

        .input-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .input-textarea {
            width: 100%;
            min-height: 100px;
            padding: 0.75rem;
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.95rem;
            resize: vertical;
        }

        .input-textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .input-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .token-counter {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .send-btn {
            background-color: var(--accent);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .send-btn:hover {
            background-color: var(--accent-hover);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Settings Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }

        .modal-content {
            position: relative;
            background-color: var(--bg-secondary);
            margin: 5% auto;
            padding: 2rem;
            width: 90%;
            max-width: 600px;
            border-radius: 8px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .setting-group {
            margin-bottom: 1.5rem;
        }

        .setting-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .setting-input {
            width: 100%;
            padding: 0.5rem;
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .slider {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 4px;
            background: var(--bg-tertiary);
            outline: none;
            border-radius: 2px;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: var(--accent);
            cursor: pointer;
            border-radius: 50%;
        }

        .slider-value {
            min-width: 50px;
            text-align: right;
        }

        /* New styles for generation controls */
        .setting-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .setting-group.half {
            flex: 1;
        }

        .setting-select {
            width: 100%;
            padding: 0.5rem;
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .setting-input {
            width: 100%;
            padding: 0.5rem;
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .warning-message {
            background-color: rgba(255, 152, 0, 0.1);
            border: 1px solid var(--warning);
            color: var(--warning);
            padding: 0.75rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        /* Image Generation Interface */
        .image-container {
            display: none;
            flex: 1;
            padding: 1rem;
            gap: 1rem;
        }

        .image-controls {
            background-color: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 8px;
        }

        .image-output {
            flex: 1;
            background-color: var(--bg-secondary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .generated-image, .generated-video {
            max-width: 100%;
            max-height: 100%;
            border-radius: 4px;
        }

        .image-placeholder {
            text-align: center;
            color: var(--text-secondary);
        }

        /* Loading */
        .loading {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .spinner {
            border: 3px solid var(--bg-tertiary);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .modal-content {
                width: 95%;
                margin: 2% auto;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--border);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="model-info">
            <h1 class="model-name" id="modelName">Loading...</h1>
            <div class="model-status">
                <span class="status-indicator"></span>
                <span id="modelStatus">Initializing</span>
            </div>
        </div>
        <button class="settings-btn" onclick="openSettings()">Settings ‚öô</button>
    </div>

    <div class="container">
        <main class="main-content">
            <!-- Chat Interface -->
            <div class="chat-container" id="chatInterface">
                <div class="messages-container" id="messages"></div>
                <div class="input-container">
                    <div class="input-wrapper">
                        <textarea 
                            class="input-textarea" 
                            id="userInput" 
                            placeholder="Type your message..."
                            onkeydown="handleKeyPress(event)"
                        ></textarea>
                        <div class="input-controls">
                            <span class="token-counter" id="tokenCounter">0 tokens</span>
                            <label style="display: none;" id="reasoningModeLabel">
                                <input type="checkbox" id="reasoningMode"> Reasoning mode
                            </label>
                        </div>
                    </div>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()">Send</button>
                </div>
            </div>

            <!-- Image Generation Interface -->
            <div class="image-container" id="imageInterface">
                <div class="image-controls">
                    <div class="setting-group">
                        <label class="setting-label">Prompt</label>
                        <textarea class="input-textarea" id="imagePrompt" placeholder="Describe the image..."></textarea>
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">Negative Prompt</label>
                        <textarea class="input-textarea" id="negativePrompt" placeholder="What to avoid..."></textarea>
                    </div>
                    
                    <!-- Size Presets -->
                    <div class="setting-group">
                        <label class="setting-label">Size Preset</label>
                        <select class="setting-select" id="sizePreset" onchange="applySizePreset()">
                            <option value="custom">Custom</option>
                            <optgroup label="Square">
                                <option value="256x256">256√ó256 (Small)</option>
                                <option value="512x512" selected>512√ó512 (Standard)</option>
                                <option value="768x768">768√ó768 (Large)</option>
                                <option value="1024x1024">1024√ó1024 (XL)</option>
                            </optgroup>
                            <optgroup label="Portrait">
                                <option value="512x768">512√ó768</option>
                                <option value="768x1024">768√ó1024</option>
                            </optgroup>
                            <optgroup label="Landscape">
                                <option value="768x512">768√ó512</option>
                                <option value="1024x768">1024√ó768</option>
                            </optgroup>
                            <optgroup label="Video" id="videoPresets" style="display: none;">
                                <option value="128x128">128√ó128 (Fast, Always Works)</option>
                                <option value="256x256">256√ó256 (Recommended)</option>
                                <option value="512x512">512√ó512 (May Fail - GPU Limited)</option>
                            </optgroup>
                        </select>
                    </div>
                    
                    <!-- Size Controls -->
                    <div class="setting-row">
                        <div class="setting-group half">
                            <label class="setting-label">Width</label>
                            <select class="setting-select" id="imageWidth" onchange="onSizeChange()">
                                <option value="128">128</option>
                                <option value="256">256</option>
                                <option value="512" selected>512</option>
                                <option value="768">768</option>
                                <option value="1024">1024</option>
                            </select>
                        </div>
                        <div class="setting-group half">
                            <label class="setting-label">Height</label>
                            <select class="setting-select" id="imageHeight" onchange="onSizeChange()">
                                <option value="128">128</option>
                                <option value="256">256</option>
                                <option value="512" selected>512</option>
                                <option value="768">768</option>
                                <option value="1024">1024</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Size warning for video models -->
                    <div class="warning-message" id="sizeWarning" style="display: none;">
                        ‚ö†Ô∏è Large video sizes may fail due to GPU memory limits. The model will automatically retry with smaller dimensions if needed.
                    </div>
                    
                    <!-- Video-specific controls (hidden by default) -->
                    <div class="setting-group" id="videoControls" style="display: none;">
                        <label class="setting-label">Number of Frames</label>
                        <div class="slider-container">
                            <input type="range" class="slider" id="numFrames" min="1" max="64" step="1" value="16">
                            <span class="slider-value" id="numFramesValue">16</span>
                        </div>
                    </div>
                    
                    <!-- Generation Parameters -->
                    <div class="setting-row">
                        <div class="setting-group half">
                            <label class="setting-label">Steps</label>
                            <div class="slider-container">
                                <input type="range" class="slider" id="numSteps" min="10" max="100" step="5" value="50">
                                <span class="slider-value" id="numStepsValue">50</span>
                            </div>
                        </div>
                        <div class="setting-group half">
                            <label class="setting-label">Guidance Scale</label>
                            <div class="slider-container">
                                <input type="range" class="slider" id="guidanceScale" min="1" max="20" step="0.5" value="7.5">
                                <span class="slider-value" id="guidanceScaleValue">7.5</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Seed -->
                    <div class="setting-group">
                        <label class="setting-label">Seed (optional)</label>
                        <input type="number" class="setting-input" id="seed" placeholder="Random">
                    </div>
                    
                    <button class="send-btn" onclick="generateImage()">Generate</button>
                </div>
                <div class="image-output">
                    <div class="image-placeholder" id="imagePlaceholder">
                        Generated content will appear here
                    </div>
                    <img class="generated-image" id="generatedImage" style="display: none;">
                    <video class="generated-video" id="generatedVideo" style="display: none;" controls></video>
                    <div class="loading" id="imageLoading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Generation Settings</h2>
                <button class="close-btn" onclick="closeSettings()">&times;</button>
            </div>
            
            <div class="setting-group">
                <label class="setting-label">Temperature</label>
                <div class="slider-container">
                    <input type="range" class="slider" id="temperature" min="0" max="2" step="0.1" value="0.7">
                    <span class="slider-value" id="temperatureValue">0.7</span>
                </div>
            </div>

            <div class="setting-group">
                <label class="setting-label">Max Tokens</label>
                <div class="slider-container">
                    <input type="range" class="slider" id="maxTokens" min="1" max="4096" step="1" value="512">
                    <span class="slider-value" id="maxTokensValue">512</span>
                </div>
            </div>

            <div class="setting-group">
                <label class="setting-label">Top P</label>
                <div class="slider-container">
                    <input type="range" class="slider" id="topP" min="0" max="1" step="0.01" value="0.9">
                    <span class="slider-value" id="topPValue">0.9</span>
                </div>
            </div>

            <div class="setting-group">
                <label class="setting-label">System Prompt</label>
                <textarea class="input-textarea" id="systemPrompt" placeholder="You are a helpful assistant..."></textarea>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let modelInfo = null;
        let messages = [];
        let isGenerating = false;
        let eventSource = null;

        // Settings
        let settings = {
            temperature: 0.7,
            maxTokens: 512,
            topP: 0.9,
            systemPrompt: "You are a helpful assistant."
        };

        // Initialize
        async function initialize() {
            try {
                // Get model info
                const response = await fetch('/info');
                modelInfo = await response.json();
                
                // Update UI
                document.getElementById('modelName').textContent = modelInfo.model_id;
                document.getElementById('modelStatus').textContent = 'Ready';
                
                // Show appropriate interface
                if (modelInfo.model_family === 'language-model' || 
                    modelInfo.model_family === 'multimodal' || 
                    modelInfo.model_family === 'vision-language') {
                    document.getElementById('chatInterface').style.display = 'flex';
                    
                    // Check for reasoning support
                    if (modelInfo.capabilities.supports_reasoning) {
                        document.getElementById('reasoningModeLabel').style.display = 'block';
                    }
                } else if (modelInfo.model_family === 'image-generation' || modelInfo.model_family === 'video-generation') {
                    document.getElementById('imageInterface').style.display = 'flex';
                    document.getElementById('chatInterface').style.display = 'none';
                    
                    // Show video controls if it's a video model
                    const isVideoModel = modelInfo.model_family === 'video-generation' || 
                                       modelInfo.model_id.toLowerCase().includes('video') ||
                                       modelInfo.model_id.toLowerCase().includes('text-to-video');
                    
                    if (isVideoModel) {
                        document.getElementById('videoControls').style.display = 'block';
                        document.getElementById('videoPresets').style.display = 'block';
                        // Set default video preset
                        document.getElementById('sizePreset').value = '256x256';
                        applySizePreset();
                    }
                }
                
                // Setup slider listeners
                setupSliders();
                
                // Load settings from localStorage
                loadSettings();
                
            } catch (error) {
                console.error('Failed to initialize:', error);
                document.getElementById('modelStatus').textContent = 'Error';
            }
        }

        // Chat functions
        function addMessage(role, content, thinking = null) {
            messages.push({ role, content });
            
            const messagesContainer = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            let messageHTML = `
                <div class="message-role">${role.charAt(0).toUpperCase() + role.slice(1)}:</div>
                <div class="message-content">`;
            
            if (thinking) {
                messageHTML += `
                    <div class="thinking-section">
                        <div class="thinking-header">
                            <span>ü§î Thinking...</span>
                            <button onclick="toggleThinking(this)">Show</button>
                        </div>
                        <div class="thinking-content" style="display: none;">${thinking}</div>
                    </div>`;
            }
            
            messageHTML += `${content}</div>`;
            messageDiv.innerHTML = messageHTML;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function toggleThinking(button) {
            const content = button.parentElement.nextElementSibling;
            if (content.style.display === 'none') {
                content.style.display = 'block';
                button.textContent = 'Hide';
            } else {
                content.style.display = 'none';
                button.textContent = 'Show';
            }
        }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const prompt = input.value.trim();
            
            if (!prompt || isGenerating) return;
            
            isGenerating = true;
            document.getElementById('sendBtn').disabled = true;
            
            // Add user message
            addMessage('user', prompt);
            input.value = '';
            
            try {
                // Prepare messages with system prompt
                const chatMessages = [
                    { role: 'system', content: settings.systemPrompt },
                    ...messages
                ];
                
                // Check if streaming is supported
                if (modelInfo.capabilities.supports_streaming) {
                    await streamResponse(chatMessages);
                } else {
                    await generateResponse(chatMessages);
                }
                
            } catch (error) {
                console.error('Generation error:', error);
                addMessage('assistant', 'Error: ' + error.message);
            } finally {
                isGenerating = false;
                document.getElementById('sendBtn').disabled = false;
            }
        }

        async function generateResponse(chatMessages) {
            const response = await fetch('/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    messages: chatMessages,
                    temperature: settings.temperature,
                    max_tokens: settings.maxTokens,
                    top_p: settings.topP,
                    reasoning_mode: document.getElementById('reasoningMode').checked
                })
            });
            
            const data = await response.json();
            
            if (data.thinking && data.answer) {
                addMessage('assistant', data.answer, data.thinking);
            } else {
                addMessage('assistant', data.text || 'No response');
            }
        }

        async function streamResponse(chatMessages) {
            // Create a temporary message div for streaming
            const messagesContainer = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            messageDiv.innerHTML = `
                <div class="message-role">Assistant:</div>
                <div class="message-content" id="streamingContent"></div>
            `;
            messagesContainer.appendChild(messageDiv);
            
            const streamingContent = document.getElementById('streamingContent');
            let fullContent = '';
            let thinkingContent = '';
            let answerContent = '';
            let currentSection = 'answer';
            
            // Set up SSE
            eventSource = new EventSource('/generate/stream?' + new URLSearchParams({
                messages: JSON.stringify(chatMessages),
                temperature: settings.temperature,
                max_tokens: settings.maxTokens,
                top_p: settings.topP,
                reasoning_mode: document.getElementById('reasoningMode').checked
            }));
            
            eventSource.onmessage = (event) => {
                const data = JSON.parse(event.data);
                
                if (data.finished) {
                    eventSource.close();
                    messages.push({ role: 'assistant', content: fullContent });
                } else if (data.type === 'thinking') {
                    thinkingContent += data.token;
                } else if (data.type === 'answer') {
                    answerContent += data.token;
                    streamingContent.textContent = answerContent;
                } else {
                    fullContent += data.token;
                    streamingContent.textContent = fullContent;
                }
                
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            };
            
            eventSource.onerror = (error) => {
                console.error('SSE error:', error);
                eventSource.close();
                streamingContent.textContent += '\n[Streaming error]';
            };
        }

        // Setup sliders
        function setupSliders() {
            // Setup all sliders with value display
            const sliders = [
                { id: 'temperature', valueId: 'temperatureValue' },
                { id: 'maxTokens', valueId: 'maxTokensValue' },
                { id: 'topP', valueId: 'topPValue' },
                { id: 'numSteps', valueId: 'numStepsValue' },
                { id: 'guidanceScale', valueId: 'guidanceScaleValue' },
                { id: 'numFrames', valueId: 'numFramesValue' }
            ];
            
            sliders.forEach(slider => {
                const input = document.getElementById(slider.id);
                const value = document.getElementById(slider.valueId);
                if (input && value) {
                    input.addEventListener('input', () => {
                        value.textContent = input.value;
                    });
                }
            });
        }

        // Image generation functions
        async function generateImage() {
            const prompt = document.getElementById('imagePrompt').value.trim();
            if (!prompt) return;
            
            const loading = document.getElementById('imageLoading');
            const placeholder = document.getElementById('imagePlaceholder');
            const image = document.getElementById('generatedImage');
            const video = document.getElementById('generatedVideo');
            
            loading.classList.add('active');
            placeholder.style.display = 'none';
            image.style.display = 'none';
            video.style.display = 'none';
            
            // Gather parameters
            const numStepsEl = document.getElementById('numSteps');
            const guidanceScaleEl = document.getElementById('guidanceScale');
            
            // Debug log
            console.log('UI Elements:', {
                numSteps: numStepsEl ? numStepsEl.value : 'not found',
                guidanceScale: guidanceScaleEl ? guidanceScaleEl.value : 'not found'
            });
            
            const params = {
                prompt: prompt,
                negative_prompt: document.getElementById('negativePrompt').value,
                num_inference_steps: numStepsEl ? parseInt(numStepsEl.value) : 50,
                guidance_scale: guidanceScaleEl ? parseFloat(guidanceScaleEl.value) : 7.5,
                width: parseInt(document.getElementById('imageWidth').value),
                height: parseInt(document.getElementById('imageHeight').value)
            };
            
            // Add seed if specified
            const seed = document.getElementById('seed').value;
            if (seed) {
                params.seed = parseInt(seed);
            }
            
            // Add num_frames for video models
            if (document.getElementById('videoControls').style.display !== 'none') {
                params.num_frames = parseInt(document.getElementById('numFrames').value);
            }
            
            // Log parameters being sent
            console.log('Sending params:', params);
            
            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params)
                });
                
                const data = await response.json();
                
                if (data.image) {
                    // Image generation result
                    image.src = 'data:image/png;base64,' + data.image;
                    image.style.display = 'block';
                } else if (data.video) {
                    // Video generation result
                    if (data.video.format === 'mp4' && data.video.data) {
                        // MP4 video
                        video.src = 'data:video/mp4;base64,' + data.video.data;
                        video.style.display = 'block';
                    } else if (data.video.format === 'png_sequence' && data.video.frames) {
                        // Fallback: show frames as animated slideshow
                        let frameIndex = 0;
                        image.src = 'data:image/png;base64,' + data.video.frames[0];
                        image.style.display = 'block';
                        
                        // Simple frame animation
                        setInterval(() => {
                            frameIndex = (frameIndex + 1) % data.video.frames.length;
                            image.src = 'data:image/png;base64,' + data.video.frames[frameIndex];
                        }, 125); // 8 FPS
                    }
                }
                
            } catch (error) {
                console.error('Image generation error:', error);
                placeholder.textContent = 'Error generating image';
                placeholder.style.display = 'block';
            } finally {
                loading.classList.remove('active');
            }
        }

        // Settings functions
        function openSettings() {
            document.getElementById('settingsModal').style.display = 'block';
        }

        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
            saveSettings();
        }

        function loadSettings() {
            const saved = localStorage.getItem('llmSettings');
            if (saved) {
                settings = JSON.parse(saved);
                
                // Update UI
                document.getElementById('temperature').value = settings.temperature;
                document.getElementById('temperatureValue').textContent = settings.temperature;
                document.getElementById('maxTokens').value = settings.maxTokens;
                document.getElementById('maxTokensValue').textContent = settings.maxTokens;
                document.getElementById('topP').value = settings.topP;
                document.getElementById('topPValue').textContent = settings.topP;
                document.getElementById('systemPrompt').value = settings.systemPrompt;
            }
        }

        function saveSettings() {
            settings.temperature = parseFloat(document.getElementById('temperature').value);
            settings.maxTokens = parseInt(document.getElementById('maxTokens').value);
            settings.topP = parseFloat(document.getElementById('topP').value);
            settings.systemPrompt = document.getElementById('systemPrompt').value;
            
            localStorage.setItem('llmSettings', JSON.stringify(settings));
        }

        // Event handlers
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Slider updates
        document.getElementById('temperature').addEventListener('input', (e) => {
            document.getElementById('temperatureValue').textContent = e.target.value;
        });

        document.getElementById('maxTokens').addEventListener('input', (e) => {
            document.getElementById('maxTokensValue').textContent = e.target.value;
        });

        document.getElementById('topP').addEventListener('input', (e) => {
            document.getElementById('topPValue').textContent = e.target.value;
        });

        // Token counter (simplified)
        document.getElementById('userInput').addEventListener('input', (e) => {
            const text = e.target.value;
            // Rough estimate: 1 token ‚âà 4 characters
            const tokens = Math.ceil(text.length / 4);
            document.getElementById('tokenCounter').textContent = `${tokens} tokens`;
        });

        // Size preset functions
        function applySizePreset() {
            const preset = document.getElementById('sizePreset').value;
            if (preset === 'custom') return;
            
            const [width, height] = preset.split('x');
            document.getElementById('imageWidth').value = width;
            document.getElementById('imageHeight').value = height;
            
            // Check if we need to show warning
            onSizeChange();
        }
        
        function onSizeChange() {
            // Check if current size matches any preset
            const width = document.getElementById('imageWidth').value;
            const height = document.getElementById('imageHeight').value;
            const currentSize = `${width}x${height}`;
            
            const presetSelect = document.getElementById('sizePreset');
            let found = false;
            
            for (let option of presetSelect.options) {
                if (option.value === currentSize) {
                    presetSelect.value = currentSize;
                    found = true;
                    break;
                }
            }
            
            if (!found) {
                presetSelect.value = 'custom';
            }
            
            // Show warning for large video sizes
            const isVideoModel = document.getElementById('videoControls').style.display !== 'none';
            const sizeWarning = document.getElementById('sizeWarning');
            
            if (isVideoModel && (parseInt(width) > 256 || parseInt(height) > 256)) {
                sizeWarning.style.display = 'block';
            } else {
                sizeWarning.style.display = 'none';
            }
        }

        // Close modal when clicking outside
        window.onclick = (event) => {
            const modal = document.getElementById('settingsModal');
            if (event.target === modal) {
                closeSettings();
            }
        };

        // Initialize on load
        window.onload = initialize;
    </script>
</body>
</html>